<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Map</title>
</head>
<body style="margin:0;padding:0;">
<link href='../../sszvis.css' rel='stylesheet' />
<script src="../../vendor/d3/d3.min.js"></script>
<script src="../../vendor/topojson/topojson.js"></script>
<script src="../../sszvis.js"></script>

<div id="sszvis-chart"></div>

<script data-catalog-project-expose="script.js">
(function(d3, topojson, sszvis) {
  'use strict';

  /* Configuration
  ----------------------------------------------- */
  var TITLE = 'Diagrammtitel';
  var DESCRIPTION = 'Kurze Beschreibung des Inhalts dieses Diagramms';


  /* Shortcuts
  ----------------------------------------------- */
  var vAcc = sszvis.fn.prop('value');
  var yearAcc = sszvis.fn.prop('year');
  var qAcc = sszvis.fn.prop('geoId');


  /* Application state
  ----------------------------------------------- */
  var state = {
    data: [],
    valueDomain: [0, 0],
    yearDomain: [new Date(), new Date()],
    quarters: [],
    lineData: [],
    currentYear: new Date(),
    currentMapData: [],
    highlightEntity: null,
    lineHighlightColor: sszvis.color.qual12()(0)
  };


  /* State transitions
  ----------------------------------------------- */
  var actions = {
    prepareState: function(data) {
      state.data = data;
      state.valueDomain = [0, d3.max(state.data, vAcc)];
      state.yearDomain = d3.extent(state.data, yearAcc);
      state.quarters = sszvis.fn.set(state.data, qAcc);
      var cascadedData = sszvis.cascade()
        .arrayBy(qAcc)
        .sort(function(a, b) {
          return d3.ascending(yearAcc(a), yearAcc(b));
        })
        .apply(state.data);
      state.lineData = cascadedData.map(function(lineData) {
        return {
          geoId: qAcc(sszvis.fn.first(lineData)),
          values: lineData
        };
      });
      var averageLineValues = cascadedData.reduce(function(m, lineData) {
        lineData.forEach(function(datum, index) {
          if (!m[index]) {
            m[index] = {
              year: datum.year,
              value: 0
            };
          }
          m[index].value += Math.round(datum.value / cascadedData.length);
        });
        return m;
      }, []);
      state.averageLine = {
        geoId: null,
        values: averageLineValues
      };
      state.lineData.push(state.averageLine);

      actions.resetYear();
    },

    changeYearAndEntity: function(inputDate, inputValue) {
      var closestYear = yearAcc(closestDatum(state.data, yearAcc, inputDate));
      if (state.currentYear !== closestYear) {
        state.currentMapData = state.data.filter(function(v) {
          return yearAcc(v).getFullYear() === closestYear.getFullYear();
        })
        .sort(function(a, b) {
          return d3.ascending(vAcc(a), vAcc(b)); // currentMapData has to be sorted so that d3.bisector will work on it.
        });
      }

      var closestEntry = inputValue === null ? null : closestDatum(state.currentMapData, vAcc, inputValue);
      if (state.currentYear !== closestYear || state.highlightEntity !== closestEntry) {
        state.currentYear = closestYear;
        state.highlightEntity = closestEntry;
        render(state);
      }
    },

    resetYear: function() {
      var mostRecentDate = d3.max(state.yearDomain);
      actions.changeYearAndEntity(mostRecentDate, null);
    },

    changeMapEntity: function(d) {
      state.highlightEntity = d;
      render(state);
    },

    resetMapEntity: function() {
      state.highlightEntity = null;
      render(state);
    }
  };


  /* Data initialization
  ----------------------------------------------- */
  d3.csv('data/CML_quartier_years.csv')
    .row(function(d) {
      return {
        geoId: sszvis.parse.number(d['QNr']),
        year: sszvis.parse.year(d['Jahr']),
        value: sszvis.parse.number(d['Anzahl']),
        name: d['Qname']
      };
    })
    .get(function(error, data) {
      if (error) {
        sszvis.loadError(error);
        return;
      }
      actions.prepareState(data);
    });


  /* Render
  ----------------------------------------------- */
  function render(state) {
    var outerBounds = sszvis.bounds({ height: 756, top: 0, right: 0, bottom: 0, left: 0 });
    var mapBounds = sszvis.bounds({ height: 556, top: 0, right: 0, bottom: 40, left: 0 });
    var lineChartBounds = sszvis.bounds({ height: 200, top: 20, right: 10, bottom: 30, left: 10 });


    // Scales

    var fillScale = sszvis.color.seqBlu()
      .domain(state.valueDomain);

    var xScale = d3.time.scale()
      .domain(state.yearDomain)
      .range([0, lineChartBounds.innerWidth]);

    var yScale = d3.scale.linear()
      .domain(state.valueDomain)
      .range([lineChartBounds.innerHeight, 0]);


    // Layers

    var mapHighlightData = state.highlightEntity ? [state.highlightEntity] : [];
    var lineHighlightData = state.highlightEntity ? [state.highlightEntity] : state.averageLine.values.filter(function(averageObj) {
      return yearAcc(averageObj).getFullYear() === state.currentYear.getFullYear();
    });

    var chart = sszvis.createSvgLayer('#sszvis-chart', outerBounds, {
      title: TITLE,
      description: DESCRIPTION
    });

    var map = chart.selectGroup('map')
      .datum(state.currentMapData);

    var tooltipLayer = sszvis.createHtmlLayer('#sszvis-chart')
      .datum(mapHighlightData);

    var lineChart = chart.selectGroup('line')
      .attr('transform', sszvis.fn.translateString(lineChartBounds.padding.left, mapBounds.height + lineChartBounds.padding.top))
      .datum(state.lineData);

    var highlightLayer = chart.selectGroup('highlight')
      .attr('transform', sszvis.fn.translateString(lineChartBounds.padding.left, mapBounds.height + lineChartBounds.padding.top))
      .datum(lineHighlightData);


    // Components

    var mapMaker = sszvis.map()
      .type('zurich-statistischeQuartiere')
      .keyName('geoId')
      .highlight(mapHighlightData)
      .highlightStroke(function(d) {
        return d3.hsl(fillScale(vAcc(d))).darker(0.7);
      })
      .width(mapBounds.innerWidth)
      .height(mapBounds.innerHeight)
      .fill(sszvis.fn.compose(fillScale, vAcc))
      .on('over', actions.changeMapEntity)
      .on('out', actions.resetMapEntity);

    var lineMaker = sszvis.component.line()
      .key(sszvis.fn.prop('geoId'))
      .valuesAccessor(sszvis.fn.prop('values'))
      .x(sszvis.fn.compose(xScale, yearAcc))
      .y(sszvis.fn.compose(yScale, vAcc))
      .stroke(function(lineData) {
        var isBlue;
        if (!state.highlightEntity) {
          isBlue = lineData.geoId === null; // if so, this is the average line
        } else {
          isBlue = state.highlightEntity.geoId === lineData.geoId;
        }
        // FIXME: don't hardcode color
        return isBlue ? state.lineHighlightColor : '#D6D6D6';
      });

    var xTickValues = xScale
      .ticks(4)
      .concat(state.currentYear);

    var lineXAxis = sszvis.axis.x.time()
      .scale(xScale)
      .orient('bottom')
      .tickValues(xTickValues)
      .highlightTick(isSelected);

    var lineYAxis = sszvis.axis.y()
      .scale(yScale)
      .orient('right')
      .backdrop(true);

    var slideBar = sszvis.control.slideBar()
      .x(xScale(state.currentYear))
      .y(sszvis.fn.compose(yScale, vAcc))
      .top(0)
      .bottom(lineChartBounds.innerHeight)
      .flip(function(d) {
        return xScale(yearAcc(d)) >= lineChartBounds.innerWidth / 2;
      })
      .color(sszvis.color.qual12())
      .label(function(d) {
        return 'Anzahl: ' + sszvis.format.number(d.value);
      });

    var tooltipHeader = sszvis.component.modularText()
      .bold(function(d) {
        if (!d) return;
        return vAcc(d.datum);
      })
      .plain(' Anzahl');

    var tooltip = sszvis.component.tooltip()
      .renderInto(tooltipLayer)
      .header(tooltipHeader)
      .body(function(d) {
        if (!d) return;
        return 'im ' + d.datum.name;
      })
      .visible(function(d) {
        if (!d) return;
        return state.highlightEntity === d.datum;
      });

    var legend = sszvis.legend.linearColorScale()
      .scale(fillScale)
      .width(outerBounds.width / 2)
      .labelFormat(sszvis.format.number)
      .units('Anzahl');

    // Rendering

    map.call(mapMaker);

    map.selectAll('[data-tooltip-anchor]')
      .call(tooltip);

    lineChart.call(lineMaker);

    lineChart.selectGroup('xAxis')
      .attr('transform', 'translate(0, ' + (lineChartBounds.innerHeight) + ')')
      .call(lineXAxis);

    lineChart.selectGroup('yAxis')
      .call(lineYAxis);

    highlightLayer.selectGroup('slider')
      .call(slideBar);

    chart.selectGroup('legend')
      .attr('transform', sszvis.fn.translateString(mapBounds.width / 4 - mapBounds.padding.left, mapBounds.innerHeight))
      .call(legend);


    // Interaction

    var hoverBehavior = sszvis.behavior.move()
      .xScale(xScale)
      .yScale(yScale)
      .padding({ top: 30 })
      .on('move', actions.changeYearAndEntity)
      .on('end', actions.resetYear);

    highlightLayer.selectGroup('interaction')
      .call(hoverBehavior);
  }


  /* Helper functions
  ----------------------------------------------- */
  function closestDatum(data, accessor, datum) {
    var i = d3.bisector(accessor).left(data, datum, 1);
    var d0 = data[i - 1];
    var d1 = data[i] || d0;
    return datum - accessor(d0) > accessor(d1) - datum ? d1 : d0;
  }

  function isSelected(d) {
    return sszvis.fn.stringEqual(state.currentYear, d);
  }


}(d3, topojson, sszvis));
</script>
</body>
</html>
