<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Map</title>
</head>
<body style="margin:0;padding:0;">
<link href='../../sszvis.css' rel='stylesheet' />
<script src="../../vendor/d3/d3.min.js"></script>
<script src="../../vendor/topojson/topojson.js"></script>
<script src="../../sszvis.js"></script>

<div id="sszvis-chart"></div>

<script data-catalog-project-expose="script.js">
(function(d3, topojson, sszvis) {
  'use strict';

  /* Configuration
  ----------------------------------------------- */
  var TITLE = 'Diagrammtitel';
  var DESCRIPTION = 'Kurze Beschreibung des Inhalts dieses Diagramms';
  var INITIAL_YEAR = sszvis.parse.year('2013');


  /* Shortcuts
  ----------------------------------------------- */
  var vAcc = sszvis.fn.prop('value');
  var yearAcc = sszvis.fn.prop('year');
  var qAcc = sszvis.fn.prop('geoId');


  /* Application state
  ----------------------------------------------- */
  var state = {
    data: [],
    valueDomain: [0, 0],
    yearDomain: [new Date(), new Date()],
    quarters: [],
    lineData: [],
    currentYear: null,
    currentMapData: []
  };


  /* State transitions
  ----------------------------------------------- */
  var actions = {
    prepareState: function(data) {
      state.data = data;
      state.valueDomain = [0, d3.max(state.data, vAcc)];
      state.yearDomain = d3.extent(state.data, yearAcc);
      state.quarters = sszvis.fn.set(state.data, qAcc);
      state.lineData = sszvis.cascade()
        .arrayBy(qAcc)
        .sort(function(a, b) {
          return d3.ascending(yearAcc(a), yearAcc(b));
        })
        .apply(state.data);

      actions.changeYear(INITIAL_YEAR);
    },

    changeYear: function(inputDate) {
      var year = yearAcc(closestDatum(state.data, yearAcc, inputDate));
      if (state.currentYear === year) return;
      state.currentYear = year;
      state.currentMapData = state.data.filter(function(v) {
        return yearAcc(v).getFullYear() === state.currentYear.getFullYear();
      });
      render(state);
    }
  };


  /* Data initialization
  ----------------------------------------------- */
  d3.csv('data/CML_quartier_years.csv')
    .row(function(d) {
      return {
        geoId: sszvis.parse.number(d['QNr']),
        year: sszvis.parse.year(d['Jahr']),
        value: sszvis.parse.number(d['Anzahl'])
      };
    })
    .get(function(error, data) {
      if (error) {
        sszvis.loadError(error);
        return;
      }
      actions.prepareState(data);
    });


  /* Render
  ----------------------------------------------- */
  function render(state) {
    var outerBounds = sszvis.bounds({ height: 756, top: 0, right: 0, bottom: 0, left: 0 });
    var mapBounds = sszvis.bounds({ height: 556, top: 0, right: 0, bottom: 40, left: 0 });
    var lineChartBounds = sszvis.bounds({ height: 200, top: 20, right: 10, bottom: 30, left: 10 });


    // Scales

    var fillScale = sszvis.color.seqBlu()
      .domain(state.valueDomain);

    var xScale = d3.time.scale()
      .domain(state.yearDomain)
      .range([0, lineChartBounds.innerWidth]);

    var yScale = d3.scale.linear()
      .domain(state.valueDomain)
      .range([lineChartBounds.innerHeight, 0]);


    // Layers

    var chart = sszvis.createSvgLayer('#sszvis-chart', outerBounds, {
      title: TITLE,
      description: DESCRIPTION
    });

    var map = chart.selectGroup('map')
      .datum(state.currentMapData);

    var lineChart = chart.selectGroup('line')
      .attr('transform', sszvis.fn.translateString(lineChartBounds.padding.left, mapBounds.height + lineChartBounds.padding.top))
      .datum(state.lineData);

    var highlightLayer = chart.selectGroup('highlight')
      .attr('transform', sszvis.fn.translateString(lineChartBounds.padding.left, mapBounds.height + lineChartBounds.padding.top))
      .datum(state.currentMapData);


    // Components

    var mapMaker = sszvis.map()
      .type('zurich-statistischeQuartiere')
      .width(mapBounds.innerWidth)
      .height(mapBounds.innerHeight)
      .fill(sszvis.fn.compose(fillScale, vAcc));

    var lineMaker = sszvis.component.line()
      .x(sszvis.fn.compose(xScale, yearAcc))
      .y(sszvis.fn.compose(yScale, vAcc))
      .stroke(sszvis.color.qual12());

    var xTickValues = xScale
      .ticks(4)
      .concat(state.currentYear);

    var lineXAxis = sszvis.axis.x.time()
      .scale(xScale)
      .orient('bottom')
      .tickValues(xTickValues)
      .highlightTick(isSelected);

    var lineYAxis = sszvis.axis.y()
      .scale(yScale)
      .orient('right')
      .backdrop(true);

    var slideBar = sszvis.control.slideBar()
      .x(yearAcc)
      .y(vAcc)
      .xScale(xScale)
      .yScale(yScale)
      .color(sszvis.color.qual12())
      .label(function(d) {
        return 'Anzahl: ' + d.value;
      });

    var legend = sszvis.legend.linearColorScale()
      .scale(fillScale)
      .width(outerBounds.width / 2)
      .labelFormat(sszvis.format.number)
      .units('Anzahl');

    // Rendering

    map.call(mapMaker);

    lineChart.call(lineMaker);

    lineChart.selectGroup('xAxis')
      .attr('transform', 'translate(0, ' + (lineChartBounds.innerHeight) + ')')
      .call(lineXAxis);

    lineChart.selectGroup('yAxis')
      .call(lineYAxis);

    highlightLayer.selectGroup('slider')
      .call(slideBar);

    chart.selectGroup('legend')
      .attr('transform', sszvis.fn.translateString(mapBounds.width / 4 - mapBounds.padding.left, mapBounds.innerHeight))
      .call(legend);


    // Interaction

    var clickBehavior = sszvis.behavior.click()
      .xScale(xScale)
      .yScale(yScale)
      .padding({ top: 30 })
      .on('down', actions.changeYear)
      .on('drag', actions.changeYear);

    highlightLayer.selectGroup('interaction')
      .call(clickBehavior);
  }


  /* Helper functions
  ----------------------------------------------- */
  function closestDatum(data, accessor, datum) {
    var i = d3.bisector(accessor).left(data, datum, 1);
    var d0 = data[i - 1];
    var d1 = data[i] || d0;
    return datum - accessor(d0) > accessor(d1) - datum ? d1 : d0;
  }

  function isSelected(d) {
    return sszvis.fn.stringEqual(state.currentYear, d);
  }


}(d3, topojson, sszvis));
</script>
</body>
</html>
