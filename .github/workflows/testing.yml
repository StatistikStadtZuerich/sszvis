name: Testing

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  unit-testing:
    name: "Unit Testing"
    timeout-minutes: 60
    env:
      CI: true
    runs-on: ubuntu-latest
    container: lironavon/docker-puppeteer-container:14.16.0
    steps:
      - uses: actions/checkout@v3
      - uses: DeterminateSystems/nix-installer-action@main

      - run: |
          nix develop --command bash -c \
            'npm install --frozen-lockfile'

      - run: |
          nix develop --command bash -c \
            'npm run test:unit'

  snapshot-testing:
    name: "Snapshot Testing"
    timeout-minutes: 60
    env:
      CI: true
    runs-on: ubuntu-latest
    container: lironavon/docker-puppeteer-container:14.16.0
    steps:
      - uses: actions/checkout@v3
      - uses: DeterminateSystems/nix-installer-action@main

      - run: |
          nix develop --command bash -c \
            'npm install --frozen-lockfile'

      - run: |
          nix develop --command bash -c \
            'npm run build'

      - name: Serve docs and run tests
        run: |
          nix develop --command bash -c \  
             'npx concurrently -k -s first -n "DOC,TEST" -c "magenta,blue" \
                "npm run start" \
                "npx wait-on http://localhost:8000 && npm run test:snapshot"'
