{"version":3,"file":"voronoi.js","sources":["../../src/behavior/voronoi.js"],"sourcesContent":["/**\n * Voronoi behavior\n *\n * The voronoi behavior adds an invisible layer of voronoi cells to a chart. The voronoi cells are calculated\n * based on the positions of the data objects which should be bound to the interaction layer before this behavior\n * is called on it. Each voronoi cell is associated with one data object, and this data object is passed to the event\n * callback functions.\n *\n * Like other behavior components, this behavior adds an invisible layer over the chart,\n * which the users interact with using touch or mouse actions. The behavior component then interprets\n * these interactions, and calls the relevant event handler callback functions. These callback functions are\n * passed values which represent data-space information about the nature of the interaction.\n * That last sentence was intentionally vague, because different behaviors operate in slightly different ways.\n *\n * The voronoi behavior expects to find an array of data already bound to the interaction layer. Each datum should\n * represent a point, and these points are used as the focal points of the construction of voronoi cells. These data\n * are also associated with the voronoi cells, so that when a user interacts with them, the datum and its index within the\n * bound data are passed to the callback functions. This component extends a d3.dispatch instance.\n *\n * The event handler functions are only called when the event happens within a certain distance\n * (see MAX_INTERACTION_RADIUS_SQUARED in this file) from the voronoi area's center.\n *\n * @module sszvis/behavior/voronoi\n *\n * @property {function} x                         Specify an accessor function for the x-position of the voronoi point\n * @property {function} y                         Specify an accessor function for the y-position of the voronoi point\n * @property {array[array, array]} bounds         Specify the bounds of the voronoi area. This is essential to the construction of voronoi cells\n *                                                using the d3.vornoi geom object. The bounds should determine the chart area over which you would like\n *                                                voronoi cells to be active. Note that if not specified, the voronoi cells will be very large.\n * @property {boolean} debug                      Whether the component is in debug mode. Being in debug mode renders the voroni cells obviously\n * @property {string and function} on             The .on() method should specify an event name and an event handler function.\n *                                                Possible event names are:\n *                                                'over' - when the user interacts with a voronoi area, either with a mouseover or touchstart\n *                                                'out' - when the user ceases to interact with a voronoi area, either with a mouseout or touchend\n *                                                All event handler functions are passed the datum which is the center of the voronoi area.\n *                                                Note: previously, event handlers were also passed the index of the datum within the dataset.\n *                                                However, this is no longer the case, due to the difficulty of inferring that information when hit\n *                                                testing a touch interaction on arbitrary rendered elements in the scene. In addition, the 'out' event\n *                                                used to be passed the datum itself, but this is no longer the case, also having to do with the impossibility\n *                                                of guaranteeing that there is a datum at the position of a touch, while \"panning\".\n *\n */\n\nimport { select, dispatch, Delaunay } from \"d3\";\n\nimport * as fn from \"../fn.js\";\nimport * as logger from \"../logger.js\";\nimport { elementFromEvent, datumFromPannableElement } from \"./util.js\";\nimport { component } from \"../d3-component.js\";\n\nexport default function () {\n  const event = dispatch(\"over\", \"out\");\n\n  const voronoiComponent = component()\n    .prop(\"x\")\n    .prop(\"y\")\n    .prop(\"bounds\")\n    .prop(\"debug\")\n    .render(function (data) {\n      const selection = select(this);\n      const props = selection.props();\n\n      if (!props.bounds) {\n        logger.error(\"behavior.voronoi - requires bounds\");\n        return false;\n      }\n      const delaunay = Delaunay.from(\n        data,\n        (d) => props.x(d),\n        (d) => props.y(d)\n      );\n      const voronoi = delaunay.voronoi(props.bounds);\n\n      const polys = selection\n        .selectAll(\"[data-sszvis-behavior-voronoi]\")\n        .data(voronoi.cellPolygons())\n        .join(\"path\")\n        .attr(\"data-sszvis-behavior-voronoi\", \"\")\n        .attr(\"data-sszvis-behavior-pannable\", \"\")\n        .attr(\"class\", \"sszvis-interactive\");\n\n      polys\n        .attr(\"d\", (d) => \"M\" + d.join(\"L\") + \"Z\")\n        .attr(\"fill\", \"transparent\")\n        .on(\"mouseover\", function (e) {\n          const cbox = this.parentNode.getBoundingClientRect();\n          const datumIdx = delaunay.find(e.clientX - cbox.left, e.clientY - cbox.top);\n          if (\n            eventNearPoint(e, [\n              cbox.left + props.x(data[datumIdx]),\n              cbox.top + props.y(data[datumIdx]),\n            ])\n          ) {\n            event.apply(\"over\", this, [e, data[datumIdx]]);\n          }\n        })\n        .on(\"mousemove\", function (e) {\n          const cbox = this.parentNode.getBoundingClientRect();\n          const datumIdx = delaunay.find(e.clientX - cbox.left, e.clientY - cbox.top);\n          if (\n            eventNearPoint(e, [\n              cbox.left + props.x(data[datumIdx]),\n              cbox.top + props.y(data[datumIdx]),\n            ])\n          ) {\n            event.apply(\"over\", this, [e, data[datumIdx]]);\n          } else {\n            event.apply(\"out\", this, [e]);\n          }\n        })\n        .on(\"mouseout\", function (e) {\n          event.apply(\"out\", this, [e]);\n        })\n        .on(\"touchstart\", function (e) {\n          const cbox = this.parentNode.getBoundingClientRect();\n          const datumIdx = delaunay.find(e.clientX - cbox.left, e.clientY - cbox.top);\n\n          if (\n            eventNearPoint(fn.firstTouch(e), [\n              cbox.left + props.x(data[datumIdx]),\n              cbox.top + props.y(data[datumIdx]),\n            ])\n          ) {\n            e.preventDefault();\n            event.apply(\"over\", this, [e, data[datumIdx]]);\n\n            // Attach these handlers only if the initial touch is within the max distance from the voronoi center\n            // This prevents the situation where a touch is outside that distance, and causes scrolling, but then the\n            // user moves their finger over the center of the voronoi area, and it fires an event anyway. Generally,\n            // when users are performing touches that cause scrolling, we want to avoid firing the events.\n            const pan = function () {\n              const touchEvent = fn.firstTouch(e);\n              const element = elementFromEvent(touchEvent);\n              const panDatum = datumFromPannableElement(element);\n              if (panDatum === null) {\n                event.apply(\"out\", this, [e]);\n              } else {\n                const panCbox = element.parentNode.getBoundingClientRect();\n                if (\n                  eventNearPoint(touchEvent, [\n                    panCbox.left + props.x(panDatum.data),\n                    panCbox.top + props.y(panDatum.data),\n                  ])\n                ) {\n                  // This event won't be cancelable if you start touching outside the hit area of a voronoi center,\n                  // then start scrolling, then move your finger over the hit area of a voronoi center. The browser\n                  // says you are \"still scrolling\" and won't let you cancel the event. It will issue a warning, which\n                  // we want to avoid.\n                  if (e.cancelable) {\n                    e.preventDefault();\n                  }\n                  event.apply(\"over\", this, [e, panDatum.data]);\n                } else {\n                  event.apply(\"out\", this, [e]);\n                }\n              }\n            };\n\n            const end = function () {\n              event.apply(\"out\", this, [e]);\n              select(this).on(\"touchmove\", null).on(\"touchend\", null);\n            };\n\n            select(this).on(\"touchmove\", pan).on(\"touchend\", end);\n          }\n        });\n\n      if (props.debug) {\n        polys.attr(\"stroke\", \"#f00\");\n      }\n    });\n\n  voronoiComponent.on = function () {\n    const value = event.on.apply(event, arguments);\n    return value === event ? voronoiComponent : value;\n  };\n\n  return voronoiComponent;\n}\n\n// Perform distance calculations in units squared to avoid a costly Math.sqrt\nconst MAX_INTERACTION_RADIUS_SQUARED = Math.pow(15, 2);\n\nfunction eventNearPoint(event, point) {\n  const dx = event.clientX - point[0];\n  const dy = event.clientY - point[1];\n  return dx * dx + dy * dy < MAX_INTERACTION_RADIUS_SQUARED;\n}\n"],"names":["event","dispatch","voronoiComponent","component","prop","render","data","selection","select","props","bounds","logger","delaunay","Delaunay","from","d","x","y","voronoi","polys","selectAll","cellPolygons","join","attr","on","e","cbox","parentNode","getBoundingClientRect","datumIdx","find","clientX","left","clientY","top","eventNearPoint","apply","fn","preventDefault","pan","touchEvent","element","elementFromEvent","panDatum","datumFromPannableElement","panCbox","cancelable","end","debug","value","arguments","MAX_INTERACTION_RADIUS_SQUARED","Math","pow","point","dx","dy"],"mappings":"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"}