{"version":3,"file":"app.js","sources":["../src/app.js"],"sourcesContent":["import { createDraft, finishDraft, setAutoFreeze } from \"immer\";\nimport { fallbackRender } from \"./fallback\";\nimport { viewport } from \"./viewport/resize\";\n\n// d3 mutates state in many places, which is why we have to turn this off.\nsetAutoFreeze(false);\n\n/**\n * Application loop\n *\n * Creates a stateful app that can be interacted with through actions. By providing\n * a structured approach, this allows us to optimize the render loop and clarifies\n * the relationship between state and actions.\n *\n * Within an app, state can only be modified through actions. During the render phase,\n * state is immutable and an error will be thrown if it is modified accidentally.\n *\n * Conceptually, an app works like this:\n *\n *     init\n *       ⇣\n *     state ⭢ render\n *      ⮤ action ⮠\n *\n * The basis of an app are the following three types:\n *\n * Dispatch can be used to schedule an action after rendering has been completed. In the\n * render function, dispatch is not directly accessible; instead, an actions object is\n * provided to dispatch actions by calling them as functions.\n * @typedef {(action: string, p?: Props) => void} Dispatch\n *\n * An effect can be returned from an action to schedule further actions using dispatch.\n * @typedef {(d: Dispatch, p?: Props) => void} Effect\n *\n * An action receives an Immer.js Draft that can be mutated within the action. If further\n * actions should be called after this one, an action can return an Effect.\n * @typedef {(s: Draft, p?: Props) => Effect | void} Action\n * @see {@link https://immerjs.github.io/immer/docs/produce/}\n *\n * The app can be configured with the following props:\n *\n * @prop {Object} props\n * @prop {(s: Draft) => Promise<Effect | void>} props.init - Asynchronously create\n * the initial state and optionally schedule an action\n * @prop {(s: State, as: Record<keyof props.actions, (p?: Props) => void>)} props.render - Update\n * the DOM from the state and optionally dispatch actions\n * @prop {Record<string, Action>} [props.actions] - Functions to transition the\n * application state\n * @prop {{element: string, src: string}} [props.fallback] - Render a fallback image\n *\n * @module sszvis/app\n */\nexport const app = ({ init, render, actions = {}, fallback }) => {\n  let doing;\n  let state;\n\n  invariant(isFunction(init), 'An \"init\" function returning a Promise must be provided.');\n  invariant(isFunction(render), 'A \"render\" function must be provided.');\n\n  const actionDispatchers = Object.keys(actions).reduce((acc, key) => {\n    acc[key] = (...args) => {\n      dispatch(key, args);\n    };\n    return acc;\n  }, {});\n\n  function scheduleUpdate(effect) {\n    if (!doing) {\n      doing = true;\n      requestAnimationFrame(() => {\n        render(state, actionDispatchers);\n        doing = false;\n      });\n    }\n    if (isFunction(effect)) effect(dispatch);\n  }\n\n  function dispatch(action, props) {\n    invariant(actions[action] != null, `Action \"${action}\" is not defined, add it to \"actions\".`);\n    const draft = createDraft(state);\n    const effect = actions[action](draft, ...props);\n    state = finishDraft(draft);\n    scheduleUpdate(effect);\n  }\n\n  const initialState = createDraft({});\n  init(initialState)\n    .then((effect) => {\n      state = finishDraft(initialState);\n      scheduleUpdate(effect);\n      viewport.on(\"resize\", scheduleUpdate);\n    })\n    .catch((error) => {\n      invariant(false, error);\n      fallback && fallbackRender(fallback.element, { src: fallback.src });\n    });\n};\n\n// -----------------------------------------------------------------------------\n// Helper functions\n\nfunction invariant(condition, message) {\n  if (!condition) {\n    throw new Error(`[sszvis.app] ${message}`);\n  }\n}\n\nfunction isFunction(x) {\n  return typeof x === \"function\";\n}\n"],"names":["setAutoFreeze","app","_ref","init","render","actions","fallback","doing","state","invariant","isFunction","actionDispatchers","Object","keys","reduce","acc","key","_len","arguments","length","args","Array","_key","dispatch","scheduleUpdate","effect","requestAnimationFrame","action","props","concat","draft","createDraft","finishDraft","initialState","then","viewport","on","catch","error","fallbackRender","element","src","condition","message","Error","x"],"mappings":"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"}