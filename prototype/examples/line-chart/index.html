<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Line chart</title>
  <script src="/assets/sszvis.js"></script>
</head>
<body>
  <div>
    <a id="select-all" href="#">Alle Jahre</a>
    <a id="select-1993" href="#">Nur 1993</a>
  </div>

  <script>
  var d3 = sszvis.d3;

  //
  // Register actions
  //

  sszvis.actions.register('startup', function() {
    fetchData();
  });

  var uiActions = sszvis.actions
    .register('clearYear', function() {
      sszvis.state.set('selectedYear', null);
    })
    .register('selectYear', function(year) {
      sszvis.state.set('selectedYear', year);
    });


  //
  // Handle UI events
  //
  d3.select('#select-all').on('click', function(){
    uiActions.clearYear();
  })

  d3.select('#select-1993').on('click', function(){
    uiActions.selectYear(1993);
  })


  //
  // Initialize application state
  // Start application
  //
  // var appState = sszvis.store({})
  sszvis.init({
    height: 500,
    width: 700,
    loadError: null,
    data: null,
    selectedYear: null
  }, render);


  //
  // Render (idempotent)
  //
  function render(state) {
    var data = state.data;

    if (!data) return;

    if (state.selectedYear) {
      data = data.filter(function(d){return d.year === state.selectedYear})
    }

    var chart = sszvis.chart()
      .height(state.height)
      .width(state.width)
      .padding({top: 20, right: 20, bottom: 30, left: 50})
      .render(renderChart)

    d3.select('body')
      .datum(data)
      .call(chart)
  }


  function renderChart(data, props) {
    var selection = d3.select(this).datum(data);

    var lineChart = sszvis.vis.lineChart()
      .height(props.height)
      .width(props.width)

    var xScale = d3.time.scale()
      .range([0, props.width])
      .domain(d3.extent(data, function(d){return d.date}));

    var yScale = d3.scale.linear()
      .range([props.height, 0])
      .domain(d3.extent(data, function(d){return d.value}));

    var xAxis = d3.svg.axis().scale(xScale).orient('bottom');
    var yAxis = d3.svg.axis().scale(yScale).orient("left");

    selection.selectGroup('lineChart')
      .call(lineChart)

    selection.selectGroup('xAxis')
      .attr('class', 'x axis')
      .attr('transform', sszvis.utils.translate(0, props.height))
      .call(xAxis)

    selection.selectGroup('yAxis')
      .attr('class', 'y axis')
      .call(yAxis)
  }


  //
  // Fetch data
  //
  function fetchData() {
    sszvis.DataService({
      url: "../data/simple_line.csv",
      format: 'csv',
      schema: [
        {
          key: 'Datum',
          as: 'date',
          format: d3.time.format("%d.%m.%Y").parse
        },
        {
          key: 'Datum',
          as: 'year',
          format: function(d) {
            return d3.time.format("%d.%m.%Y").parse(d).getFullYear();
          }
        },
        {
          key: 'Wert',
          as: 'value',
          format: Number
        }
      ]
    }).then(function(data){
      sszvis.state.set('data', data);
    }).catch(function(err){
      sszvis.state.set('loadError', err);
    });
  }

  </script>

</body>
</html>
