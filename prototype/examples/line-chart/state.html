<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Line chart</title>
  <script src="/assets/sszvis.js"></script>
</head>
<body>
  <div>
    <button data-clearYear>Alle Jahre</button>
    <button data-selectYear data-year="1993">1993</button>
    <button data-selectYear data-year="1995">1995</button>
  </div>

  <script>
  var d3 = sszvis.d3;
  var vis = sszvis.vis;
  var utils = sszvis.utils;


  //
  // Initialization
  //
  var appState = sszvis.store({
    chart: {
      height: 500,
      width: 700,
      padding: { top: 20, right: 20, bottom: 30, left: 50 }
    },
    loadError: null,
    data: null,
    selectedYear: null
  });

  sszvis.actions
    .register('startup', function() {
      fetchData();
    });

  var dataActions = sszvis.actions
    .channel('data')
    .register('ready', function(data) {
      appState.set('data', data);
    })
    .register('error', function(err) {
      appState.set('loadError', err);
    });

  var uiActions = sszvis.actions
    .channel('ui')
    .register('clearYear', function() {
      appState.set('selectedYear', null);
    })
    .register('selectYear', function(year) {
      appState.set('selectedYear', year);
    });


  //
  // Handle UI events
  //
  d3.selectAll('[data-clearYear]').on('click', function(){
    uiActions.clearYear();
  })

  d3.selectAll('[data-selectYear]').on('click', function() {
    uiActions.selectYear(+this.getAttribute('data-year'));
  })


  //
  // Startup
  //
  sszvis.start('body', appState, function(state) {
    var data = state.data;

    if (!data) return;

    if (state.selectedYear) {
      data = data.filter(function(d){return d.year === state.selectedYear})
    }

    var selection = d3.select(this).datum(data);

    var lineChart = vis.lineChart()
      .height(this.props.height)
      .width(this.props.width)

    var xScale = d3.time.scale()
      .range([0, this.props.width])
      .domain(d3.extent(data, function(d){return d.date}));

    var yScale = d3.scale.linear()
      .range([this.props.height, 0])
      .domain(d3.extent(data, function(d){return d.value}));

    var xAxis = d3.svg.axis().scale(xScale).orient('bottom');
    var yAxis = d3.svg.axis().scale(yScale).orient("left");

    selection.selectGroup('lineChart')
      .call(lineChart)

    selection.selectGroup('xAxis')
      .attr('class', 'x axis')
      .attr('transform', utils.translate(0, this.props.height))
      .call(xAxis)

    selection.selectGroup('yAxis')
      .attr('class', 'y axis')
      .call(yAxis)
  });


  //
  // Fetch data
  //
  function fetchData() {
    sszvis.DataService({
      url: "../data/simple_line.csv",
      format: 'csv',
      schema: [
        {
          key: 'Datum',
          as: 'date',
          format: d3.time.format("%d.%m.%Y").parse
        },
        {
          key: 'Datum',
          as: 'year',
          format: function(d) {
            return d3.time.format("%d.%m.%Y").parse(d).getFullYear();
          }
        },
        {
          key: 'Wert',
          as: 'value',
          format: Number
        }
      ]
    })
    .then(dataActions.ready)
    .catch(dataActions.error);
  }

  </script>

</body>
</html>
