<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title>Sunburst</title>
  </head>
  <body style="margin: 0; padding: 0">
    <link href="/sszvis.css" rel="stylesheet" />
    <script src="https://unpkg.com/d3@7/dist/d3.min.js"></script>
    <script src="/sszvis.js"></script>

    <div id="sszvis-chart"></div>

    <script>
      var EXTERNAL_CONFIG = {
        data: "data/sun_burst_drei_hierarchien.csv",
        id: "#sszvis-chart",
        fallback: "fallback.png",
      };
    </script>

    <script data-catalog-project-expose="script.js">
      (function (d3, sszvis, config) {
        "use strict";

        // Configuration
        // -----------------------------------------------

        function parseRow(d) {
          return {
            continent: d["kontinent"],
            region: d["region"],
            country: d["land"],
            number: sszvis.parseNumber(d["anzahl"]),
          };
        }

        const continentAcc = sszvis.prop("continent");
        const regionAcc = sszvis.prop("region");
        const countryAcc = sszvis.prop("country");
        const numAcc = sszvis.prop("number");

        // Application state
        // -----------------------------------------------
        const state = {
          data: [],
          radiusExtent: [0, 0],
          selection: [],
        };

        // State transitions
        // -----------------------------------------------
        const actions = {
          prepareState(data) {
            const continentsList = [
              "Europa",
              "Asien",
              "Amerika",
              "Afrika",
              "Ozeanien",
              "Unzuteilbar",
            ];

            // Sort the input data according to the desired order of the continents first, then by descending order of size
            data.sort((a, b) => {
              const indexDiff = d3.ascending(
                continentsList.indexOf(continentAcc(a)),
                continentsList.indexOf(continentAcc(b)),
              );
              if (indexDiff !== 0) return indexDiff;
              return d3.descending(numAcc(a), numAcc(b));
            });

            state.continents = continentsList;

            // Prepare data using the unified prepareHierarchyData function
            const hierarchicalData = sszvis
              .prepareHierarchyData()
              .layer(continentAcc)
              .layer(regionAcc)
              .layer(countryAcc)
              .value(numAcc)
              .calculate(data);

            state.data = hierarchicalData;

            const { y1, x1 } = d3.partition()(hierarchicalData.copy());

            state.radiusExtent = [y1, x1];

            render(state);
          },

          onSliceOver(e, d) {
            state.selection = [d];

            render(state);
          },

          onSliceOut() {
            state.selection = [];

            render(state);
          },

          resize() {
            render(state);
          },
        };

        // Data initialization
        // -----------------------------------------------
        d3.csv(config.data, parseRow)
          .then(actions.prepareState)
          .catch(sszvis.loadError);

        // Render
        // -----------------------------------------------
        function render(state) {
          const legendLayout = sszvis.colorLegendLayout(
            {
              legendLabels: state.continents,
            },
            config.id,
          );

          const colorScale = legendLayout.scale;
          const colorLegend = legendLayout.legend;

          const bounds = sszvis.bounds(
            {
              top: 20,
              right: 20,
              bottom: legendLayout.bottomPadding,
              left: 20,
            },
            config.id,
          );

          const burstLayout = sszvis.sunburstLayout(
            3,
            Math.min(bounds.innerWidth, bounds.innerHeight),
          );

          // Scales

          const radiusScale = d3
            .scaleLinear()
            .domain(state.radiusExtent)
            .range([0, burstLayout.numLayers * burstLayout.ringWidth]);

          // Layers

          const chartLayer = sszvis
            .createSvgLayer(config.id, bounds)
            .datum(state.data);

          const tooltipLayer = sszvis.createHtmlLayer(config.id, bounds);

          // Components
          // Note: the angleScale property has a sensible default, but should be
          // configured if you're not using sszvis.sunburstLayout
          const sunburstMaker = sszvis
            .sunburst()
            .fill(colorScale)
            .radiusScale(radiusScale)
            .centerRadius(burstLayout.centerRadius);

          const tooltipText = sszvis.modularTextHTML().bold((d) => d.data.key);

          const tooltip = sszvis
            .tooltip()
            .renderInto(tooltipLayer)
            .orientation(sszvis.fitTooltip("bottom", bounds))
            .visible(isSelected)
            .header(tooltipText)
            .body((d) => sszvis.formatNumber(d.value));

          // Rendering

          const sunburstGroup = chartLayer
            .selectGroup("sunburst")
            .attr(
              "transform",
              sszvis.translateString(
                bounds.innerWidth / 2,
                bounds.innerHeight / 2,
              ),
            )
            .call(sunburstMaker);

          chartLayer
            .selectGroup("colorLegend")
            .attr(
              "transform",
              sszvis.translateString(
                (bounds.innerWidth - legendLayout.legendWidth) / 2,
                bounds.innerHeight + 20,
              ),
            )
            .call(colorLegend);

          sunburstGroup.selectAll("[data-tooltip-anchor]").call(tooltip);

          // Interaction

          const interactionLayer = sszvis
            .panning()
            .elementSelector(".sszvis-sunburst-arc")
            .on("start", actions.onSliceOver)
            .on("pan", actions.onSliceOver)
            .on("end", actions.onSliceOut);

          sunburstGroup.call(interactionLayer);

          sszvis.viewport.on("resize", actions.resize);
        }

        function isSelected(d) {
          return state.selection.includes(d);
        }
      })(d3, sszvis, EXTERNAL_CONFIG);
    </script>
  </body>
</html>
