{"version":3,"file":"sunburst.js","sources":["../../src/component/sunburst.js"],"sourcesContent":["/**\n * Sunburst component\n *\n * This component renders a sunburst diagram, which is kind of like a layered pie chart. There is an\n * inner ring of values, which are total values for some large category. Each of these categories can\n * be broken down into smaller categories, which are shown in another layer around the inner ring. If these\n * categories can in turn be broken down into smaller ones, you can add yet another layer. The result\n * is a hierarchical display with the level of aggregation getting finer and finer as you get further\n * from the center of the chart.\n *\n * This component uses the data structure returned by the sszvis.layout.sunbust.prepareData function, and\n * can be configured using the sszvis.layout.sunburst.computeLayout function. Under the hood, the prepareData\n * function uses d3's nest data transformer (d3.nest) to construct a nested data structure from the input\n * array, and d3's partition layout (d3.layout.partition), and the resulting data structure will be\n * familiar to those familiar with the partition layout.\n *\n * @property {Function} angleScale              Scale function for the angle of the segments of the sunburst chart. If using the\n *                                              sszvis.layout.sunburst.prepareData function, the domain will be [0, 1]. The range\n *                                              should usually be [0, 2 * PI]. That domain and range are used as default for this property.\n * @property {Function} radiusScale             Scale function for the radius of segments. Can be configured using values returned from\n *                                              sszvis.layout.sunburst.computeLayout. See the examples for how the scale setup works.\n * @property {Number} centerRadius              The radius of the center of the chart. Can be configured with sszvis.layout.sunburst.computeLayout.\n * @property {Function} fill                    Function that returns the fill color for the segments in the center of the chart. Note that this will only be\n *                                              called on the centermost segments. The segments which are subcategories of these center segments\n *                                              will have their fill determined recursively, by lightening the color of its parent segment.\n * @property {Color, Function} stroke           The stroke color of the segments. Defaults to white.\n *\n * @return {sszvis.component}\n */\n\nimport { select, scaleLinear, hsl, arc, interpolate } from \"d3\";\n\nimport * as logger from \"../logger.js\";\nimport { defaultTransition } from \"../transition.js\";\nimport tooltipAnchor from \"../annotation/tooltipAnchor.js\";\nimport { component } from \"../d3-component.js\";\n\nconst TWO_PI = 2 * Math.PI;\n\nexport default function () {\n  return component()\n    .prop(\"angleScale\")\n    .angleScale(scaleLinear().range([0, 2 * Math.PI]))\n    .prop(\"radiusScale\")\n    .prop(\"centerRadius\")\n    .prop(\"fill\")\n    .prop(\"stroke\")\n    .stroke(\"white\")\n    .render(function (data) {\n      const selection = select(this);\n      const props = selection.props();\n\n      // Accepts a sunburst node and returns a d3.hsl color for that node (sometimes operates recursively)\n      function getColorRecursive(node) {\n        // Center node (if the data were prepared using sszvis.layout.sunburst.prepareData)\n        if (node.data.isSunburstRoot) {\n          return \"transparent\";\n        } else if (!node.parent) {\n          // Accounts for incorrectly formatted data which hasn't gone through sszvis.layout.sunburst.prepareData\n          logger.warn(\n            \"Data passed to sszvis.component.sunburst does not have the expected tree structure. You should prepare it using sszvis.format.sunburst.prepareData\"\n          );\n          return hsl(props.fill(node.data.key));\n        } else if (node.parent.data.isSunburstRoot) {\n          // Use the color scale\n          return hsl(props.fill(node.data.key));\n        } else {\n          // Recurse up the tree and adjust the lightness value\n          const pColor = getColorRecursive(node.parent);\n          pColor.l *= 1.15;\n          return pColor;\n        }\n      }\n\n      const startAngle = function (d) {\n        return Math.max(0, Math.min(TWO_PI, props.angleScale(d.x0)));\n      };\n      const endAngle = function (d) {\n        return Math.max(0, Math.min(TWO_PI, props.angleScale(d.x1)));\n      };\n      const innerRadius = function (d) {\n        return props.centerRadius + Math.max(0, props.radiusScale(d.y0));\n      };\n      const outerRadius = function (d) {\n        return props.centerRadius + Math.max(0, props.radiusScale(d.y1));\n      };\n\n      const arcGen = arc()\n        .startAngle(startAngle)\n        .endAngle(endAngle)\n        .innerRadius(innerRadius)\n        .outerRadius(outerRadius);\n\n      for (const d of data) {\n        // _x and _dx are the destination values for the transition.\n        // We set these to the computed x and dx.\n        d._x0 = d.x0;\n        d._x1 = d.x1;\n      }\n\n      const arcs = selection\n        .selectAll(\".sszvis-sunburst-arc\")\n        .each((d, i) => {\n          if (data[i]) {\n            // x and dx are the current/transitioning values\n            // We set these here, in case any datums already exist which have values set\n            data[i].x0 = d.x0;\n            data[i].x1 = d.x1;\n            // The transition tweens from x and dx to _x and _dx\n          }\n        })\n        .data(data)\n        .join(\"path\")\n        .attr(\"class\", \"sszvis-sunburst-arc\");\n\n      arcs.attr(\"stroke\", props.stroke).attr(\"fill\", getColorRecursive);\n\n      arcs.transition(defaultTransition()).attrTween(\"d\", (d) => {\n        const x0Interp = interpolate(d.x0, d._x0);\n        const x1Interp = interpolate(d.x1, d._x1);\n        return function (t) {\n          d.x0 = x0Interp(t);\n          d.x1 = x1Interp(t);\n          return arcGen(d);\n        };\n      });\n\n      // Add tooltip anchors\n      const arcTooltipAnchor = tooltipAnchor().position((d) => {\n        const startA = startAngle(d);\n        const endA = endAngle(d);\n        const a = startA + Math.abs(endA - startA) / 2 - Math.PI / 2;\n        const r = (innerRadius(d) + outerRadius(d)) / 2;\n        return [Math.cos(a) * r, Math.sin(a) * r];\n      });\n\n      selection.call(arcTooltipAnchor);\n    });\n}\n"],"names":["TWO_PI","Math","PI","component","prop","angleScale","scaleLinear","range","stroke","render","data","selection","select","props","getColorRecursive","node","isSunburstRoot","parent","logger","hsl","fill","key","pColor","l","startAngle","d","max","min","x0","endAngle","x1","innerRadius","centerRadius","radiusScale","y0","outerRadius","y1","arcGen","arc","_x0","_x1","arcs","selectAll","each","i","join","attr","transition","defaultTransition","attrTween","x0Interp","interpolate","x1Interp","t","arcTooltipAnchor","tooltipAnchor","position","startA","endA","a","abs","r","cos","sin","call"],"mappings":"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"}