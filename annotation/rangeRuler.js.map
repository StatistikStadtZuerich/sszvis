{"version":3,"file":"rangeRuler.js","sources":["../../src/annotation/rangeRuler.js"],"sourcesContent":["/**\n * RangeRuler annotation\n *\n * The range ruler is similar to the handle ruler and the ruler, except for each data\n * point which it finds bound to its layer, it generates two small dots, and a label which\n * states the value of the data point. For an example, see the interactive stacked area charts.\n * Note that the interactive stacked area charts also include the rangeFlag component for highlighting\n * certain specific dots. This is a sepearate component.\n *\n * @module sszvis/annotation/rangeRuler\n *\n * @property {number functor} x            A function for the x-position of the ruler.\n * @property {number functor} y0           A function for the y-position of the lower dot. Called for each datum.\n * @property {number functor} y1           A function for the y-position of the upper dot. Called for each datum.\n * @property {number} top                  A number for the y-position of the top of the ruler\n * @property {number} bottom               A number for the y-position of the bottom of the ruler\n * @property {string functor} label        A function which generates labels for each range.\n * @property {number} total                A number to display as the total of the range ruler (at the top)\n * @property {boolean functor} flip        Determines whether the rangeRuler labels should be flipped (they default to the right side)\n *\n * @return {sszvis.component}\n */\n\nimport { select } from \"d3\";\n\nimport * as fn from \"../fn.js\";\nimport { halfPixel } from \"../svgUtils/crisp.js\";\nimport { formatNumber } from \"../format.js\";\nimport { component } from \"../d3-component.js\";\n\nexport default function () {\n  return component()\n    .prop(\"x\", fn.functor)\n    .prop(\"y0\", fn.functor)\n    .prop(\"y1\", fn.functor)\n    .prop(\"top\")\n    .prop(\"bottom\")\n    .prop(\"label\")\n    .prop(\"removeStroke\")\n    .label(fn.functor(\"\"))\n    .prop(\"total\")\n    .prop(\"flip\", fn.functor)\n    .flip(false)\n    .render(function (data) {\n      const selection = select(this);\n      const props = selection.props();\n\n      const crispX = fn.compose(halfPixel, props.x);\n      const crispY0 = fn.compose(halfPixel, props.y0);\n      const crispY1 = fn.compose(halfPixel, props.y1);\n      const middleY = function (d) {\n        return halfPixel((props.y0(d) + props.y1(d)) / 2);\n      };\n\n      const dotRadius = 1.5;\n\n      const line = selection\n        .selectAll(\".sszvis-rangeRuler__rule\")\n        .data([0])\n        .join(\"line\")\n        .classed(\"sszvis-rangeRuler__rule\", true);\n\n      line.attr(\"x1\", crispX).attr(\"y1\", props.top).attr(\"x2\", crispX).attr(\"y2\", props.bottom);\n\n      const marks = selection\n        .selectAll(\".sszvis-rangeRuler--mark\")\n        .data(data)\n        .join(\"g\")\n        .classed(\"sszvis-rangeRuler--mark\", true);\n\n      marks.append(\"circle\").classed(\"sszvis-rangeRuler__p1\", true);\n      marks.append(\"circle\").classed(\"sszvis-rangeRuler__p2\", true);\n      marks.append(\"text\").classed(\"sszvis-rangeRuler__label-contour\", true);\n      marks.append(\"text\").classed(\"sszvis-rangeRuler__label\", true);\n\n      marks\n        .selectAll(\".sszvis-rangeRuler__p1\")\n        .data((d) => [d])\n        .attr(\"cx\", crispX)\n        .attr(\"cy\", crispY0)\n        .attr(\"r\", dotRadius);\n\n      marks\n        .selectAll(\".sszvis-rangeRuler__p2\")\n        .data((d) => [d])\n        .attr(\"cx\", crispX)\n        .attr(\"cy\", crispY1)\n        .attr(\"r\", dotRadius);\n\n      marks\n        .selectAll(\".sszvis-rangeRuler__label\")\n        .data((d) => [d])\n        .attr(\"x\", (d) => {\n          const offset = props.flip(d) ? -10 : 10;\n          return crispX(d) + offset;\n        })\n        .attr(\"y\", middleY)\n        .attr(\"dy\", \"0.35em\") // vertically-center\n        .style(\"text-anchor\", (d) => (props.flip(d) ? \"end\" : \"start\"))\n        .text(fn.compose(formatNumber, props.label));\n\n      //make the contour behind the the label update with the label\n      marks\n        .selectAll(\".sszvis-rangeRuler__label-contour\")\n        .data((d) => [d])\n        .attr(\"x\", (d) => {\n          const offset = props.flip(d) ? -10 : 10;\n          return crispX(d) + offset;\n        })\n        .attr(\"y\", middleY)\n        .attr(\"dy\", \"0.35em\") // vertically-center\n        .style(\"text-anchor\", (d) => (props.flip(d) ? \"end\" : \"start\"))\n        .text(fn.compose(formatNumber, props.label));\n\n      selection.selectAll(\"g.sszvis-rangeRuler--mark\").each(function () {\n        const g = select(this);\n        const textNode = g.select(\"text\").node();\n        let textContour = g.select(\".sszvis-rangeRuler__label-contour\");\n        if (textContour.empty()) {\n          textContour = select(textNode.cloneNode())\n            .classed(\"sszvis-rangeRuler__label-contour\", true)\n            .classed(\"sszvis-rangeRuler__label\", false);\n          this.insertBefore(textContour.node(), textNode);\n        } else {\n          textContour\n            .attr(\"x\", (d) => {\n              const offset = props.flip(d) ? -10 : 10;\n              return crispX(d) + offset;\n            })\n            .attr(\"y\", middleY)\n            .attr(\"dy\", \"0.35em\") // vertically-center\n            .style(\"text-anchor\", (d) => (props.flip(d) ? \"end\" : \"start\"));\n        }\n        textContour.text(textNode.textContent);\n      });\n\n      if (!props.removeStroke) {\n        marks.attr(\"stroke\", \"white\").attr(\"stroke-width\", 0.5).attr(\"stroke-opacity\", 0.75);\n      }\n\n      const total = selection\n        .selectAll(\".sszvis-rangeRuler__total\")\n        .data([fn.last(data)])\n        .join(\"text\")\n        .classed(\"sszvis-rangeRuler__total\", true);\n\n      total\n        .attr(\"x\", (d) => {\n          const offset = props.flip(d) ? -10 : 10;\n          return crispX(d) + offset;\n        })\n        .attr(\"y\", props.top - 10)\n        .style(\"text-anchor\", (d) => (props.flip(d) ? \"end\" : \"start\"))\n        .text(\"Total \" + formatNumber(props.total));\n\n      const totalNode = total.node();\n      let totalContour = selection.select(\".sszvis-rangeRuler__total-contour\");\n      if (totalContour.empty()) {\n        totalContour = select(totalNode.cloneNode())\n          .classed(\"sszvis-rangeRuler__total-contour\", true)\n          .classed(\"sszvis-rangeRuler__total\", false);\n        this.insertBefore(totalContour.node(), totalNode);\n      } else {\n        totalContour\n          .attr(\"x\", (d) => {\n            const offset = props.flip(d) ? -10 : 10;\n            return crispX(d) + offset;\n          })\n          .attr(\"y\", props.top - 10)\n          .style(\"text-anchor\", (d) => (props.flip(d) ? \"end\" : \"start\"));\n      }\n      totalContour.text(totalNode.textContent);\n\n      if (!props.removeStroke) {\n        total.attr(\"stroke\", \"white\").attr(\"stroke-width\", 0.5).attr(\"stroke-opacity\", 0.75);\n      }\n    });\n}\n"],"names":["component","prop","fn","label","flip","render","data","selection","select","props","crispX","halfPixel","x","crispY0","y0","crispY1","y1","middleY","d","dotRadius","line","selectAll","join","classed","attr","top","bottom","marks","append","offset","style","text","formatNumber","each","g","textNode","node","textContour","empty","cloneNode","insertBefore","textContent","removeStroke","total","totalNode","totalContour"],"mappings":"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"}